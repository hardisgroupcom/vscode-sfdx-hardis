<template>
  <div class="blue-back">
    <div class="slds-scope slds-p-around_small blue-back">
      <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
        <div class="slds-col slds-size_4-of-12 slds-align-left">
          <template if:true={isBranch}>
            <span class="slds-text-heading_medium slds-text-title_bold">Pipeline Settings for major git branch <b>{branchName}</b></span>
          </template>
          <template if:false={isBranch}>
            <span class="slds-text-heading_medium slds-text-title_bold">Global Pipeline Settings</span>
          </template>
        </div>
        <div class="slds-col slds-size_4-of-12 slds-align-middle">
          <div class="slds-form-element">
            <lightning-combobox
              name="configScope"
              label="Configuration Scope"
              variant="label-hidden"
              value={selectedConfigScope}
              placeholder="Select configuration scope"
              options={configScopeOptions}
              onchange={handleConfigScopeChange}
              disabled={isEditMode}
            ></lightning-combobox>
          </div>
        </div>
        <div class="slds-col slds-size_4-of-12 slds-no-flex slds-align-middle" data-key="top-btn-group" style="text-align:right;">
          <template if:true={isEditMode}>
            <lightning-button variant="brand" label="Save" onclick={handleSave} class="slds-m-right_small" data-button="top"></lightning-button>
            <lightning-button variant="neutral" label="Cancel" onclick={handleCancel} data-button="top"></lightning-button>
          </template>
          <template if:false={isEditMode}>
            <lightning-button variant="brand" label="Edit" onclick={handleEdit} data-button="top"></lightning-button>
          </template>
        </div>
      </div>
    <div class="slds-p-horizontal_small">
      <template if:true={configSections}>
        <lightning-card hide-header="true" label="Pipeline Settings">
          <lightning-tabset>
            <template for:each={configSections} for:item="section" for:index="index">
              <lightning-tab key={section.label} label={section.label}>
                <div class="slds-p-around_medium">
                  <template if:true={section.description}>
                    <div class="slds-text-body_regular slds-text-color_weak slds-m-bottom_medium">
                      {section.description}
                    </div>
                  </template>
                <template for:each={section.entries} for:item="entry">
                  <div key={entry.key} class="slds-m-bottom_medium">
                    <div class="slds-grid slds-gutters">
                      <div class={entry.columnClass}>
                        <template if:true={isEditMode}>
                          <template if:true={entry.isEnum}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:flex;align-items:center;gap:0.25rem;">
                                <span>{entry.label}</span>
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              <lightning-combobox
                                data-key={entry.key}
                                value={entry.valueEdit}
                                options={entry.optionsLwc}
                                onchange={handleInputChange}
                                variant="label-hidden"
                              ></lightning-combobox>
                            </div>
                          </template>
                          <template if:true={entry.isArrayEnum}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:flex;align-items:center;gap:0.25rem;">
                                <span>{entry.label}</span>
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              <lightning-dual-listbox
                                data-key={entry.key}
                                value={entry.valueEdit}
                                options={entry.optionsLwc}
                                onchange={handleInputChange}
                                label="Select values"
                              ></lightning-dual-listbox>
                            </div>
                          </template>
                          <template if:true={entry.isArrayText}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:flex;align-items:center;gap:0.25rem;">
                                <span>{entry.label}</span>
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              <lightning-textarea
                                data-key={entry.key}
                                value={entry.valueEditText}
                                onchange={handleInputChange}
                                rows="2"
                                variant="label-hidden"
                              ></lightning-textarea>
                              <div class="slds-text-body_small slds-text-color_weak">One value per line</div>
                            </div>
                          </template>
                          <template if:true={entry.isArrayObject}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:flex;align-items:center;gap:0.25rem;">
                                <span>{entry.label}</span>
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              
                              <!-- Display existing items as datatable -->
                              <template if:true={entry.hasArrayObjectValues}>
                                <lightning-datatable
                                  key-field="_index"
                                  data={entry.arrayObjectDatatableData}
                                  column-widths-mode="auto"
                                  columns={entry.arrayObjectDatatableColumns}
                                  data-key={entry.key}
                                  onrowaction={handleArrayObjectRowAction}
                                  hide-checkbox-column
                                  class="slds-m-bottom_medium"
                                ></lightning-datatable>
                              </template>
                              
                              <!-- Add New Button (Edit mode only) -->
                              <template if:true={isEditMode}>
                                <div class="add-button-container">
                                  <lightning-button
                                    variant="brand"
                                    label="Add New"
                                    icon-name="utility:add"
                                    data-key={entry.key}
                                    onclick={handleAddArrayObjectItem}
                                  ></lightning-button>
                                </div>
                              </template>
                              
                              <!-- Modal for adding/editing item -->
                              <template if:true={entry.arrayObjectEditorOpen}>
                                <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
                                  <div class="slds-modal__container">
                                    <header class="slds-modal__header">
                                      <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" data-key={entry.key} onclick={handleCancelArrayObjectForm}>
                                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                                        <span class="slds-assistive-text">Close</span>
                                      </button>
                                      <h2 class="slds-modal__title slds-hyphenate">
                                        <template if:true={entry.arrayObjectEditIndex}>
                                          Edit Item
                                        </template>
                                        <template if:false={entry.arrayObjectEditIndex}>
                                          Add New Item
                                        </template>
                                      </h2>
                                    </header>
                                    <div class="slds-modal__content slds-p-around_medium">
                                      <template for:each={entry.arrayObjectFormFields} for:item="field">
                                        <template if:true={field.isText}>
                                          <div key={field.key} class="slds-form-element slds-m-bottom_small">
                                            <label class="slds-form-element__label">
                                              <span>{field.label}</span>
                                              <template if:true={field.required}>
                                                <abbr class="slds-required" title="required">*</abbr>
                                              </template>
                                            </label>
                                            <lightning-input
                                              type="text"
                                              value={field.value}
                                              placeholder={field.placeholder}
                                              data-key={entry.key}
                                              data-field-name={field.key}
                                              data-field-type="text"
                                              onchange={handleArrayObjectFormFieldChange}
                                              required={field.required}
                                              variant="label-hidden"
                                            ></lightning-input>
                                            <template if:true={field.description}>
                                              <div class="slds-text-body_small slds-text-color_weak">{field.description}</div>
                                            </template>
                                          </div>
                                        </template>
                                        
                                        <template if:true={field.isEnum}>
                                          <div key={field.key} class="slds-form-element slds-m-bottom_small">
                                            <label class="slds-form-element__label">
                                              <span>{field.label}</span>
                                              <template if:true={field.required}>
                                                <abbr class="slds-required" title="required">*</abbr>
                                              </template>
                                            </label>
                                            <lightning-combobox
                                              value={field.value}
                                              placeholder={field.placeholder}
                                              options={field.options}
                                              data-key={entry.key}
                                              data-field-name={field.key}
                                              data-field-type="enum"
                                              onchange={handleArrayObjectFormFieldChange}
                                              required={field.required}
                                              variant="label-hidden"
                                            ></lightning-combobox>
                                            <template if:true={field.description}>
                                              <div class="slds-text-body_small slds-text-color_weak">{field.description}</div>
                                            </template>
                                          </div>
                                        </template>
                                        
                                        <template if:true={field.isBoolean}>
                                          <div key={field.key} class="slds-form-element slds-m-bottom_small">
                                            <lightning-input
                                              type="toggle"
                                              label={field.label}
                                              checked={field.value}
                                              data-key={entry.key}
                                              data-field-name={field.key}
                                              data-field-type="boolean"
                                              onchange={handleArrayObjectFormFieldChange}
                                            ></lightning-input>
                                            <template if:true={field.description}>
                                              <div class="slds-text-body_small slds-text-color_weak">{field.description}</div>
                                            </template>
                                          </div>
                                        </template>
                                      </template>
                                    </div>
                                    <footer class="slds-modal__footer">
                                      <lightning-button
                                        variant="neutral"
                                        label="Cancel"
                                        data-key={entry.key}
                                        onclick={handleCancelArrayObjectForm}
                                      ></lightning-button>
                                      <lightning-button
                                        variant="brand"
                                        label="Save"
                                        data-key={entry.key}
                                        onclick={handleSaveArrayObjectItem}
                                      ></lightning-button>
                                    </footer>
                                  </div>
                                </section>
                                <div class="slds-backdrop slds-backdrop_open"></div>
                              </template>
                            </div>
                          </template>
                          <template if:true={entry.isBoolean}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:block;">
                                {entry.label}
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              <lightning-input
                                type="toggle"
                                data-key={entry.key}
                                checked={entry.valueEdit}
                                onchange={handleInputChange}
                                oninput={handleInputChange}
                                class="slds-m-bottom_xx-small"
                                variant="label-hidden"
                              ></lightning-input>
                            </div>
                          </template>
                          <template if:true={entry.isText}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:flex;align-items:center;gap:0.25rem;">
                                <span>{entry.label}</span>
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              <lightning-input
                                type="text"
                                data-key={entry.key}
                                value={entry.valueEdit}
                                onchange={handleInputChange}
                                variant="label-hidden"
                              ></lightning-input>
                            </div>
                          </template>
                          <template if:true={entry.isNumber}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:flex;align-items:center;gap:0.25rem;">
                                <span>{entry.label}</span>
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              <lightning-input
                                type="number"
                                data-key={entry.key}
                                value={entry.valueEdit}
                                onchange={handleInputChange}
                                variant="label-hidden"
                              ></lightning-input>
                            </div>
                          </template>
                          <template if:true={entry.inherited}>
                            <div class="slds-text-color_weak slds-text-body_small">Global: {entry.globalValue}</div>
                          </template>
                        </template>
                        <template if:false={isEditMode}>
                          <template if:true={entry.isBoolean}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:block;">
                                {entry.label}
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              <lightning-input
                                type="toggle"
                                checked={entry.value}
                                disabled
                                class="slds-m-bottom_xx-small"
                                variant="label-hidden"
                              ></lightning-input>
                            </div>
                          </template>
                          <template if:false={entry.isBoolean}>
                            <div class="slds-form-element slds-m-bottom_xx-small">
                              <label class="slds-form-element__label" style="display:flex;align-items:center;gap:0.25rem;">
                                <span>{entry.label}</span>
                                <template if:true={entry.description}>
                                  <s-multiline-helptext content={entry.description} class="slds-icon-text-info"></s-multiline-helptext>
                                </template>
                              </label>
                              <template if:true={entry.isArrayEnum}>
                                <template if:true={entry.hasArrayEnumValues}>
                                  <ul class="slds-list_dotted slds-m-left_medium">
                                    <template for:each={entry.valueDisplay} for:item="item">
                                      <li key={item}>{item}</li>
                                    </template>
                                  </ul>
                                </template>
                                <template if:false={entry.hasArrayEnumValues}>
                                  <span class="slds-text-color_weak">None</span>
                                </template>
                              </template>
                              <template if:true={entry.isArrayText}>
                                <template if:true={entry.hasArrayTextValues}>
                                  <ul class="slds-list_dotted slds-m-left_medium">
                                    <template for:each={entry.valueDisplay} for:item="item">
                                      <li key={item}>{item}</li>
                                    </template>
                                  </ul>
                                </template>
                                <template if:false={entry.hasArrayTextValues}>
                                  <span class="slds-text-color_weak">None</span>
                                </template>
                              </template>
                              <template if:true={entry.isArrayObject}>
                                <template if:true={entry.hasArrayObjectValues}>
                                  <lightning-datatable
                                    key-field="_index"
                                    data={entry.arrayObjectDatatableData}
                                    column-widths-mode="auto"
                                    columns={entry.arrayObjectDatatableColumns}
                                    hide-checkbox-column
                                    class="slds-m-top_x-small"
                                  ></lightning-datatable>
                                </template>
                                <template if:false={entry.hasArrayObjectValues}>
                                  <span class="slds-text-color_weak">None</span>
                                </template>
                              </template>
                              <template if:true={entry.isText}>
                                <template if:true={entry.hasValue}>
                                  <span class="slds-text-color_weak">{entry.value}</span>
                                </template>
                                <template if:false={entry.hasValue}>
                                  <span class="slds-text-color_weak">None</span>
                                </template>
                              </template>
                              <template if:true={entry.isNumber}>
                                <template if:true={entry.hasValue}>
                                  <span class="slds-text-color_weak">{entry.value}</span>
                                </template>
                                <template if:false={entry.hasValue}>
                                  <span class="slds-text-color_weak">None</span>
                                </template>
                              </template>
                            </div>
                          </template>
                          <template if:true={entry.inherited}>
                            <span class="slds-badge slds-theme_info slds-m-left_x-small" title="Inherited from global config">inherited</span>
                          </template>
                        </template>
                      </div>
                      <template if:false={entry.isArrayObject}>
                        <div class="slds-col slds-size_3-of-12 slds-text-align_right">
                          <template if:true={entry.hasDocUrl}>
                            <lightning-button
                              variant="neutral"
                              label="Documentation"
                              icon-name="utility:link"
                              icon-position="left"
                              onclick={handleOpenDocUrl}
                              data-doc-url={entry.docUrl}
                              size="small"
                            ></lightning-button>
                          </template>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </lightning-tab>
          </template>
        </lightning-tabset>
        </lightning-card>
      </template>
      </div>
      <!--
      <div class="slds-grid slds-grid_align-end slds-m-top_medium" data-key="bottom-btn-group">
        <template if:true={isEditMode}>
          <lightning-button variant="brand" label="Save" onclick={handleSave} class="slds-m-right_small" data-button="bottom"></lightning-button>
          <lightning-button variant="neutral" label="Cancel" onclick={handleCancel} data-button="bottom"></lightning-button>
        </template>
        <template if:false={isEditMode}>
          <lightning-button variant="brand" label="Edit" onclick={handleEdit} data-button="bottom"></lightning-button>
        </template>
      </div>
      -->
    </div>
  </div>
</template>
