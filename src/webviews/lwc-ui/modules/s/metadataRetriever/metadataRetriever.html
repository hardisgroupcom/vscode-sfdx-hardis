<template>
  <div class="slds-p-around_small blue-back">
    <lightning-card title="Metadata Retriever" icon-name="custom:custom63">
      <!-- Filters Section -->
      <div class="slds-p-around_small">
        <div class="slds-grid slds-gutters slds-wrap">
          <!-- Org Selection -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-combobox
              label="Selected Org"
              value={selectedOrg}
              options={orgOptions}
              onchange={handleOrgChange}
              required
            ></lightning-combobox>
          </div>

          <!-- Metadata Type Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-combobox
              label="Metadata Type"
              value={metadataType}
              options={metadataTypeOptions}
              onchange={handleMetadataTypeChange}
              placeholder="Select metadata type"
            ></lightning-combobox>
          </div>

          <!-- Metadata Name Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-input
              label="Metadata Name"
              value={metadataName}
              onchange={handleMetadataNameChange}
              placeholder="e.g., MyClass, Account"
            ></lightning-input>
          </div>

          <!-- Last Updated By Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-input
              label="Last Updated By"
              value={lastUpdatedBy}
              onchange={handleLastUpdatedByChange}
              placeholder="e.g., John Doe"
            ></lightning-input>
          </div>

          <!-- Date From Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-input
              type="date"
              label="Updated From"
              value={dateFrom}
              onchange={handleDateFromChange}
            ></lightning-input>
          </div>

          <!-- Date To Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-input
              type="date"
              label="Updated To"
              value={dateTo}
              onchange={handleDateToChange}
            ></lightning-input>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="slds-m-top_small">
          <lightning-button
            variant="brand"
            label="Search"
            icon-name="utility:search"
            onclick={handleSearch}
            disabled={cannotSearch}
            class="slds-m-right_x-small"
          ></lightning-button>
          <lightning-button
            variant="neutral"
            label="Refresh"
            icon-name="utility:refresh"
            onclick={handleRefresh}
            disabled={cannotSearch}
            class="slds-m-right_x-small"
          ></lightning-button>
          <lightning-button
            variant="neutral"
            label="Clear Filters"
            icon-name="utility:clear"
            onclick={handleClearFilters}
          ></lightning-button>
        </div>
      </div>

      <!-- Loading Spinner -->
      <template if:true={isLoading}>
        <div class="slds-p-around_small slds-text-align_center">
          <lightning-spinner alternative-text="Loading metadata..." size="medium"></lightning-spinner>
        </div>
      </template>

      <!-- Error Message -->
      <template if:true={hasError}>
        <div class="slds-p-around_small">
          <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
            <span class="slds-assistive-text">error</span>
            <lightning-icon icon-name="utility:error" size="x-small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
            <h2>{error}</h2>
          </div>
        </div>
      </template>

      <!-- Results Datatable -->
      <template if:true={hasResults}>
        <div class="slds-p-around_small">
          <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_small">
            <div class="slds-col slds-no-flex">
              <span class="slds-text-title_caps slds-text-color_weak">
                {filteredMetadata.length} result(s) found
              </span>
            </div>
            <div class="slds-col slds-grow slds-p-left_small slds-p-right_small">
              <lightning-input
                value={searchTerm}
                onchange={handleSearchChange}
                placeholder="Search in results..."
                variant="label-hidden"
                icon-name="utility:clear"
              ></lightning-input>
            </div>
            <template if:true={hasSelectedRows}>
              <div class="slds-col slds-no-flex">
                <lightning-button
                  variant="success"
                  label={retrieveSelectedLabel}
                  icon-name="utility:download"
                  onclick={handleRetrieveSelected}
                  size="small"
                ></lightning-button>
              </div>
            </template>
          </div>
          <lightning-datatable
            key-field="uniqueKey"
            data={filteredMetadata}
            columns={columns}
            column-widths-mode="auto"
            selected-rows={selectedRowKeys}
            onrowaction={handleRowAction}
            onrowselection={handleRowSelection}
            onsort={handleSort}
            sorted-by={sortBy}
            sorted-direction={sortDirection}
          ></lightning-datatable>
        </div>
      </template>

      <!-- No Results Message -->
      <template if:true={noResults}>
        <div class="slds-p-around_small slds-text-align_center">
          <div class="slds-illustration slds-illustration_small">
            <div class="slds-text-color_weak">
              <h3 class="slds-text-heading_medium">No metadata found</h3>
              <p class="slds-text-body_regular">Try adjusting your search criteria</p>
            </div>
          </div>
        </div>
      </template>
    </lightning-card>
  </div>
</template>
