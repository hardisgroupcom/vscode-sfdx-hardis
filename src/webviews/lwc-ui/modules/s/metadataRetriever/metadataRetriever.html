<template>
  <div class="slds-p-around_x-small blue-back">
    <lightning-card title="Sfdx-Hardis Metadata Retriever" icon-name="custom:custom63">
      <!-- Selected Org and Query Mode in Card Header -->
      <div slot="actions" class="slds-grid slds-grid_align-end slds-gutters_small slds-grid_vertical-align-start">
        <div class="slds-col slds-no-flex slds-align-top">
          <fieldset class="slds-form-element" role="group" aria-label="Selected Org">
            <legend class="slds-form-element__legend slds-form-element__label" part=""></legend>
            <div class="slds-form-element__control">
              <lightning-combobox
                label="Selected Org"
                value={selectedOrg}
                options={orgOptions}
                onchange={handleOrgChange}
                required
                variant="label-hidden"
              ></lightning-combobox>
            </div>
          </fieldset>
        </div>
        <div class="slds-col slds-no-flex slds-align-top">
          <lightning-radio-group
            options={queryModeOptions}
            value={queryMode}
            onchange={handleQueryModeChange}
            type="button"
          ></lightning-radio-group>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="slds-p-around_x-small">
        <div class="slds-grid slds-gutters_x-small slds-wrap">
          <!-- Metadata Type Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-combobox
              label="Metadata Type"
              value={metadataType}
              options={metadataTypeOptions}
              onchange={handleMetadataTypeChange}
              placeholder="Select metadata type"
              required={isAllMetadataMode}
            ></lightning-combobox>
          </div>

          <!-- Metadata Name Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-input
              label="Metadata Name"
              value={metadataName}
              onchange={handleMetadataNameChange}
              placeholder="e.g., MyClass, Account"
            ></lightning-input>
          </div>

          <!-- Last Updated By Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-input
              label="Last Updated By"
              value={lastUpdatedBy}
              onchange={handleLastUpdatedByChange}
              placeholder="e.g., John Doe"
            ></lightning-input>
          </div>

          <!-- Date From Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-input
              type="date"
              label="Updated From"
              value={dateFrom}
              onchange={handleDateFromChange}
            ></lightning-input>
          </div>

          <!-- Date To Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-input
              type="date"
              label="Updated To"
              value={dateTo}
              onchange={handleDateToChange}
            ></lightning-input>
          </div>

          <!-- Package Filter -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-6">
            <lightning-combobox
              label="Package"
              value={packageFilter}
              options={packageOptions}
              onchange={handlePackageChange}
              placeholder="Select package"
            ></lightning-combobox>
          </div>

        </div>

        <!-- Action Buttons -->
        <div class="slds-m-top_x-small slds-grid slds-grid_vertical-align-center slds-grid_align-spread">
          <div class="slds-col">
            <lightning-button
              variant="brand"
              label="Search"
              icon-name="utility:search"
              onclick={handleSearch}
              disabled={cannotSearch}
              class="slds-m-right_small"
              size="small"
            ></lightning-button>
            <lightning-button
              variant="neutral"
              label="Clear Filters"
              icon-name="utility:clear"
              onclick={handleClearFilters}
              size="small"
            ></lightning-button>
          </div>
          <div class="slds-col slds-no-flex slds-form-element slds-form-element_compact">
            <div class="slds-form-element__control slds-grid slds-grid_vertical-align-center" style="align-items:center;">
              <div class="slds-m-right_x-small slds-text-body_regular slds-align-middle">Check local files</div>
              <lightning-input
                type="toggle"
                label="Check local files"
                aria-label="Check local files"
                checked={checkLocalFiles}
                onchange={handleCheckLocalChange}
                variant="label-hidden"
                disabled={checkLocalDisabled}
                title={checkLocalTooltip}
              ></lightning-input>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Spinner -->
      <template if:true={isLoading}>
        <div class="slds-p-around_small slds-text-align_center">
          <lightning-spinner alternative-text="Loading metadata..." size="medium"></lightning-spinner>
        </div>
      </template>

      <!-- Error Message -->
      <template if:true={hasError}>
        <div class="slds-p-around_small">
          <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
            <span class="slds-assistive-text">error</span>
            <lightning-icon icon-name="utility:error" size="x-small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
            <h2>{error}</h2>
          </div>
        </div>
      </template>

      <!-- Initial Prompt (before any search) -->
      <template if:false={hasSearched}>
        <div class="slds-p-around_small slds-text-align_center slds-text-color_weak">
          <h3 class="slds-text-heading_medium">No search performed yet</h3>
          <p>Click the <strong>Search</strong> button to query metadata for the selected org.</p>
        </div>
      </template>

      <!-- Results Datatable -->
      <template if:true={hasResults}>
        <div class="slds-p-around_x-small">
          <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_small">
            <div class="slds-col slds-no-flex">
              <span class="slds-text-title_caps slds-text-color_weak">
                {filteredMetadata.length} result(s) found
              </span>
            </div>
            <div class="slds-col slds-grow slds-p-left_small slds-p-right_small">
              <lightning-input
                value={searchTerm}
                onchange={handleSearchChange}
                placeholder="Search in results..."
                variant="label-hidden"
                icon-name="utility:clear"
              ></lightning-input>
            </div>
            <template if:true={hasSelectedRows}>
              <div class="slds-col slds-no-flex">
                <lightning-button
                  data-id="retrieve-button"
                  variant="success"
                  label={retrieveSelectedLabel}
                  icon-name="utility:download"
                  onclick={handleRetrieveSelected}
                  size="small"
                ></lightning-button>
              </div>
            </template>
          </div>
          <lightning-datatable
            key-field="uniqueKey"
            data={filteredMetadata}
            columns={columns}
            column-widths-mode="auto"
            selected-rows={selectedRowKeys}
            onrowaction={handleRowAction}
            onrowselection={handleRowSelection}
            onsort={handleSort}
            sorted-by={sortBy}
            sorted-direction={sortDirection}
          ></lightning-datatable>
        </div>
      </template>

      <!-- Floating retrieve button (shown when main retrieve button is off-screen) -->
      <div class="retrieve-floating" data-id="retrieve-button-floating">
        <lightning-button
          variant="success"
          label={retrieveSelectedLabel}
          icon-name="utility:download"
          onclick={handleRetrieveSelected}
        ></lightning-button>
      </div>

      <!-- Hidden feature modal (obfuscated identifiers) -->
      <template if:true={showFeature}>
        <section role="dialog" tabindex="-1" data-feature data-feature-id={featureId} aria-modal="true">
          <div data-feature-backdrop onclick={hideFeature}></div>
          <div data-feature-content>
            <button data-feature-close onclick={hideFeature} title="Close">×</button>
            <div data-feature-body>
              <img src={featureLogoImg} alt="" />
              <h2>Surprise ❤️</h2>
              <p>You've found the secret — enjoy!</p>
            </div>
          </div>
        </section>
      </template>

      <!-- No Results Message -->
      <template if:true={noResults}>
        <div class="slds-p-around_small slds-text-align_center">
          <div class="slds-illustration slds-illustration_small">
            <div class="slds-text-color_weak">
              <h3 class="slds-text-heading_medium">No metadata found</h3>
              <p class="slds-text-body_regular">Try adjusting your search criteria</p>
            </div>
          </div>
        </div>
      </template>
    </lightning-card>
  </div>
</template>
